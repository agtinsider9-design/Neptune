<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NEPTUNE</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Outfit', 'sans-serif'],
                    },
                    animation: {
                        'blob': 'blob 7s infinite',
                        'fade-in': 'fadeIn 0.5s ease-out forwards',
                    },
                    keyframes: {
                        blob: {
                            '0%': { transform: 'translate(0px, 0px) scale(1)' },
                            '33%': { transform: 'translate(30px, -50px) scale(1.1)' },
                            '66%': { transform: 'translate(-20px, 20px) scale(0.9)' },
                            '100%': { transform: 'translate(0px, 0px) scale(1)' },
                        },
                        fadeIn: {
                            '0%': { opacity: '0', transform: 'translateY(10px)' },
                            '100%': { opacity: '1', transform: 'translateY(0)' },
                        }
                    }
                }
            }
        }
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&display=swap');

        body {
            /* Smooth background transition */
            transition: background-color 0.5s ease, color 0.5s ease;
        }

        /* LIGHT MODE BACKGROUND */
        body:not(.dark) {
            background-color: #f3f4f6;
            background-image: 
                radial-gradient(at 0% 0%, hsla(253,16%,7%,0) 0, transparent 50%), 
                radial-gradient(at 50% 0%, hsla(225,39%,30%,0) 0, transparent 50%), 
                radial-gradient(at 100% 0%, hsla(339,49%,30%,0) 0, transparent 50%);
            color: #1f2937;
        }

        /* DARK MODE BACKGROUND */
        body.dark {
            background-color: #0f1016;
            background-image: 
                radial-gradient(circle at top left, #1a1c2e, #0f1016);
            color: white;
        }

        /* Universal Glass Card - Adaptive */
        .glass-card {
            transition: all 0.3s ease;
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            border: 1px solid;
        }

        /* Light Mode Card */
        body:not(.dark) .glass-card {
            background: rgba(255, 255, 255, 0.7);
            border-color: rgba(255, 255, 255, 0.5);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -1px rgba(0, 0, 0, 0.03);
        }

        /* Dark Mode Card */
        body.dark .glass-card {
            background: rgba(255, 255, 255, 0.03);
            border-color: rgba(255, 255, 255, 0.08);
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.3);
        }

        /* Adaptive Inputs */
        .adaptive-input {
            transition: all 0.3s ease;
        }
        body:not(.dark) .adaptive-input {
            background-color: #ffffff;
            border-color: #e5e7eb;
            color: #111827;
        }
        body:not(.dark) .adaptive-input:focus {
            border-color: #6366f1;
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
        }
        body.dark .adaptive-input {
            background-color: rgba(15, 16, 22, 0.5);
            border-color: rgba(55, 65, 81, 0.5);
            color: #f3f4f6;
        }
        body.dark .adaptive-input:focus {
            border-color: #6366f1;
            box-shadow: 0 0 0 2px rgba(99, 102, 241, 0.2);
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        body.dark ::-webkit-scrollbar-thumb { background: #2d3047; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        body.dark ::-webkit-scrollbar-thumb:hover { background: #434766; }

        /* Chat Bubbles */
        .chat-bubble-user {
            background: linear-gradient(135deg, #6366f1 0%, #4f46e5 100%);
            border-radius: 18px 18px 0 18px;
            color: white;
        }
        .chat-bubble-bot {
            border-radius: 18px 18px 18px 0;
            border: 1px solid;
        }
        body:not(.dark) .chat-bubble-bot {
            background: white;
            border-color: #e5e7eb;
            color: #374151;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        body.dark .chat-bubble-bot {
            background: rgba(255, 255, 255, 0.05);
            border-color: rgba(255, 255, 255, 0.1);
            color: #e5e7eb;
        }

        .typing-dot { animation: typing 1.4s infinite ease-in-out both; }
        .typing-dot:nth-child(1) { animation-delay: -0.32s; }
        .typing-dot:nth-child(2) { animation-delay: -0.16s; }
        @keyframes typing { 0%, 80%, 100% { transform: scale(0); } 40% { transform: scale(1); } }

        /* Upload Zone */
        .file-upload-zone { border: 2px dashed; transition: all 0.3s ease; }
        body:not(.dark) .file-upload-zone { border-color: #cbd5e1; color: #64748b; }
        body:not(.dark) .file-upload-zone:hover { border-color: #6366f1; background: #f5f3ff; }
        body.dark .file-upload-zone { border-color: rgba(255, 255, 255, 0.1); color: #9ca3af; }
        body.dark .file-upload-zone:hover { border-color: #6366f1; background: rgba(99, 102, 241, 0.05); }

        /* Active Tab */
        .tab-btn.active { background-color: #4f46e5; color: white; box-shadow: 0 4px 12px rgba(79, 70, 229, 0.3); }
        .tab-btn:not(.active) { color: inherit; opacity: 0.6; }
        .tab-btn:not(.active):hover { opacity: 1; background: rgba(0,0,0,0.05); }
        body.dark .tab-btn:not(.active):hover { background: rgba(255,255,255,0.05); }
    </style>
</head>
<body class="flex flex-col items-center p-4 min-h-screen relative overflow-x-hidden selection:bg-indigo-500 selection:text-white">

    <!-- Decorative Background Blobs (Light Mode Only) -->
    <div class="fixed top-0 left-0 w-full h-full overflow-hidden -z-10 pointer-events-none opacity-50 dark:opacity-0 transition-opacity duration-500">
        <div class="absolute top-0 left-1/4 w-96 h-96 bg-purple-300 rounded-full mix-blend-multiply filter blur-3xl opacity-30 animate-blob"></div>
        <div class="absolute top-0 right-1/4 w-96 h-96 bg-yellow-300 rounded-full mix-blend-multiply filter blur-3xl opacity-30 animate-blob animation-delay-2000"></div>
        <div class="absolute -bottom-32 left-1/3 w-96 h-96 bg-pink-300 rounded-full mix-blend-multiply filter blur-3xl opacity-30 animate-blob animation-delay-4000"></div>
    </div>

    <!-- Header & Navigation -->
    <header class="w-full max-w-6xl flex flex-col md:flex-row justify-between items-center mb-6 gap-4 animate-fade-in z-20">
        <div class="flex items-center gap-3">
            <div class="bg-indigo-600 p-2.5 rounded-xl text-white shadow-lg shadow-indigo-500/30">
                <i class="fa-solid fa-layer-group text-xl"></i>
            </div>
            <div>
                <h1 class="text-2xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-indigo-600 to-purple-600 dark:from-white dark:to-gray-400">
                    NEPTUNE
                </h1>
                <p class="text-xs text-gray-500 dark:text-gray-400 font-medium">Ultimate AI Workspace</p>
            </div>
        </div>

        <div class="flex items-center gap-4">
            <!-- Theme Toggle -->
            <button id="themeToggle" class="w-10 h-10 rounded-full flex items-center justify-center bg-white dark:bg-white/5 border border-gray-200 dark:border-white/10 shadow-sm hover:shadow-md transition-all text-yellow-500 dark:text-indigo-400">
                <i class="fa-solid fa-sun dark:hidden"></i>
                <i class="fa-solid fa-moon hidden dark:block"></i>
            </button>

            <!-- Tab Switcher -->
            <div class="flex bg-gray-200 dark:bg-[#0f1016]/60 p-1.5 rounded-xl border border-gray-300 dark:border-gray-700/50 backdrop-blur-md">
                <button onclick="switchTab('image')" id="tab-image" class="tab-btn active px-5 py-2 rounded-lg text-sm font-bold flex items-center gap-2 transition-all">
                    <i class="fa-solid fa-wand-magic-sparkles"></i> <span class="hidden sm:inline">Image AI</span>
                </button>
                <button onclick="switchTab('chat')" id="tab-chat" class="tab-btn px-5 py-2 rounded-lg text-sm font-bold flex items-center gap-2 transition-all">
                    <i class="fa-solid fa-robot"></i> <span class="hidden sm:inline">BatGPT</span>
                </button>
            </div>
        </div>
    </header>

    <!-- VIEW 1: IMAGE GENERATOR -->
    <div id="image-view" class="w-full max-w-6xl grid grid-cols-1 lg:grid-cols-12 gap-6 animate-fade-in">
        
        <!-- Controls (Left Side) -->
        <div class="lg:col-span-5 glass-card rounded-3xl p-6 sm:p-8 flex flex-col h-full relative overflow-hidden group">
            <!-- Gradient Line Top -->
            <div class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-indigo-500 via-purple-500 to-pink-500"></div>

            <div class="mb-6 flex justify-between items-end">
                <div>
                    <h2 class="text-xl font-bold dark:text-gray-200 text-gray-800">Generate Art</h2>
                    <p class="text-gray-500 dark:text-gray-400 text-xs mt-1">Transform text into visuals</p>
                </div>
                <div class="bg-indigo-100 dark:bg-indigo-500/20 text-indigo-600 dark:text-indigo-300 text-xs px-2 py-1 rounded font-bold">
                    V2.0
                </div>
            </div>

            <form id="generatorForm" class="space-y-5 flex-grow flex flex-col z-10">
                <div class="space-y-2">
                    <div class="flex justify-between items-center">
                        <label class="text-xs font-bold text-gray-500 dark:text-gray-400 uppercase tracking-wider ml-1">Prompt</label>
                        <button type="button" onclick="surpriseMe()" class="text-xs text-indigo-500 hover:text-indigo-600 dark:text-indigo-400 font-medium flex items-center gap-1 transition-colors">
                            <i class="fa-solid fa-dice"></i> Surprise Me
                        </button>
                    </div>
                    <textarea id="promptInput" rows="3" class="adaptive-input w-full rounded-xl p-4 text-sm font-medium focus:outline-none transition-all resize-none" placeholder="A futuristic city floating in the clouds, cyberpunk style..." required></textarea>
                </div>

                <!-- File & Ratio Grid -->
                <div class="grid grid-cols-2 gap-4">
                    <!-- File Upload -->
                    <div class="space-y-2 col-span-2 sm:col-span-1">
                        <label class="text-xs font-bold text-gray-500 dark:text-gray-400 uppercase tracking-wider ml-1">Reference</label>
                         <div class="relative group h-[52px]">
                            <input type="file" id="fileInput" class="hidden" accept="image/*">
                            <label for="fileInput" id="dropZone" class="file-upload-zone w-full h-full rounded-xl cursor-pointer flex items-center justify-center gap-2 text-xs font-medium">
                                <i class="fa-solid fa-paperclip"></i>
                                <span id="fileLabel">Attach Image</span>
                            </label>
                            <div id="uploadPreview" class="hidden absolute top-1 right-1 bottom-1 w-12 bg-cover bg-center rounded-lg border border-gray-300 dark:border-gray-600"></div>
                         </div>
                    </div>

                    <!-- Aspect Ratio -->
                    <div class="space-y-2 col-span-2 sm:col-span-1">
                        <label class="text-xs font-bold text-gray-500 dark:text-gray-400 uppercase tracking-wider ml-1">Ratio</label>
                        <select id="aspectRatio" class="adaptive-input w-full rounded-xl p-3 text-sm font-medium focus:outline-none cursor-pointer h-[52px]">
                            <option value="square">1:1 Square</option>
                            <option value="portrait">3:4 Portrait</option>
                            <option value="landscape">4:3 Landscape</option>
                        </select>
                    </div>
                </div>

                <!-- Style Select -->
                <div class="space-y-2">
                    <label class="text-xs font-bold text-gray-500 dark:text-gray-400 uppercase tracking-wider ml-1">Style Preset</label>
                    <div class="relative">
                        <select id="styleSelect" class="adaptive-input w-full appearance-none rounded-xl p-3.5 pl-4 pr-10 text-sm font-medium focus:outline-none cursor-pointer">
                            <option value="">No Filter (Raw)</option>
                            <option value="cinematic lighting, 8k, photorealistic, octane render">Cinematic Realistic</option>
                            <option value="anime style, studio ghibli, vibrant colors">Anime / Manga</option>
                            <option value="cyberpunk, neon lights, dark atmosphere, futuristic">Cyberpunk</option>
                            <option value="3d render, cute, isometric, blender style">3D Isometric</option>
                            <option value="oil painting, impasto, vincent van gogh style">Oil Painting</option>
                        </select>
                        <div class="absolute right-4 top-1/2 -translate-y-1/2 text-gray-400 pointer-events-none">
                            <i class="fa-solid fa-chevron-down text-xs"></i>
                        </div>
                    </div>
                </div>

                <button type="submit" id="generateBtn" class="w-full bg-gradient-to-r from-indigo-600 to-purple-600 hover:from-indigo-500 hover:to-purple-500 text-white rounded-xl p-4 font-bold transition-all shadow-lg shadow-indigo-500/30 dark:shadow-indigo-900/40 mt-auto flex justify-center items-center gap-2 transform active:scale-95">
                    <i class="fa-solid fa-wand-magic-sparkles"></i> <span id="btnText">Generate Masterpiece</span>
                </button>
            </form>
        </div>

        <!-- Preview (Right Side) -->
        <div class="lg:col-span-7 flex flex-col gap-4 h-full">
            
            <!-- Main Display -->
            <div class="glass-card rounded-3xl p-4 sm:p-6 flex-grow min-h-[400px] relative overflow-hidden flex flex-col">
                <div class="flex justify-between items-center mb-4 z-10">
                    <h2 class="text-lg font-bold text-gray-800 dark:text-gray-200">Canvas</h2>
                    <div id="statusBadge" class="hidden px-3 py-1 rounded-full bg-yellow-500/10 text-yellow-600 dark:text-yellow-400 text-xs font-bold border border-yellow-500/20 flex items-center gap-2">
                        <span class="w-2 h-2 bg-yellow-500 rounded-full animate-pulse"></span> Generative Process
                    </div>
                </div>

                <div class="flex-grow rounded-2xl overflow-hidden bg-gray-100 dark:bg-[#1e2130] border border-gray-200 dark:border-gray-700/30 relative flex items-center justify-center group w-full h-full">
                    <!-- Background Grid Pattern -->
                    <div class="absolute inset-0 opacity-10 dark:opacity-20 pointer-events-none" style="background-image: radial-gradient(#6366f1 1px, transparent 1px); background-size: 20px 20px;"></div>

                    <!-- Placeholder -->
                    <div id="placeholderState" class="text-center p-8 z-0">
                        <div class="w-20 h-20 bg-gray-200 dark:bg-white/5 rounded-2xl flex items-center justify-center mx-auto mb-4 text-gray-400 dark:text-gray-500 rotate-3 transition-transform group-hover:rotate-0">
                            <i class="fa-regular fa-image text-3xl"></i>
                        </div>
                        <p class="text-gray-500 dark:text-gray-400 text-sm font-medium">Your imagination awaits...</p>
                    </div>

                    <!-- Loader -->
                    <div id="loadingState" class="hidden absolute inset-0 bg-white/80 dark:bg-black/60 backdrop-blur-md flex flex-col items-center justify-center z-20">
                        <div class="relative w-20 h-20">
                            <div class="absolute top-0 left-0 w-full h-full border-4 border-indigo-200 dark:border-indigo-900 rounded-full"></div>
                            <div class="absolute top-0 left-0 w-full h-full border-4 border-indigo-600 border-t-transparent rounded-full animate-spin"></div>
                        </div>
                        <p class="text-indigo-600 dark:text-indigo-300 text-sm font-bold mt-4 animate-pulse">Dreaming...</p>
                    </div>

                    <!-- Image -->
                    <img id="resultImage" crossOrigin="anonymous" src="" class="hidden w-full h-full object-contain z-10 transition-transform duration-500 group-hover:scale-[1.02]">

                    <!-- Hover Overlay Actions -->
                    <div id="actionOverlay" class="hidden absolute bottom-6 flex gap-3 z-20 translate-y-10 opacity-0 group-hover:translate-y-0 group-hover:opacity-100 transition-all duration-300">
                        <button id="downloadBtn" class="bg-white text-gray-900 px-5 py-2.5 rounded-full text-xs font-bold hover:bg-gray-100 shadow-xl flex items-center gap-2 transform hover:-translate-y-1 transition-transform">
                            <i class="fa-solid fa-download text-indigo-600"></i> Save
                        </button>
                        <button onclick="openFull()" class="bg-gray-900/80 backdrop-blur text-white px-5 py-2.5 rounded-full text-xs font-bold border border-white/20 hover:bg-black shadow-xl transform hover:-translate-y-1 transition-transform">
                            <i class="fa-solid fa-expand"></i>
                        </button>
                    </div>
                </div>
                
                <!-- Error Toast -->
                <div id="errorMessage" class="hidden absolute bottom-6 left-6 right-6 p-4 rounded-xl bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-500/30 text-red-600 dark:text-red-300 text-sm font-medium flex items-center gap-3 shadow-lg z-30 animate-fade-in">
                    <i class="fa-solid fa-circle-exclamation"></i> <span id="errorText">Error</span>
                </div>
            </div>

            <!-- Gallery Strip (New Feature) -->
            <div class="glass-card rounded-2xl p-3 h-24 flex items-center gap-3 overflow-x-auto" id="galleryStrip">
                <span class="text-xs text-gray-400 font-medium px-2 whitespace-nowrap">Session Gallery</span>
                <!-- Javascript will populate thumbnails here -->
                <div class="h-16 w-16 rounded-lg bg-gray-100 dark:bg-white/5 border border-dashed border-gray-300 dark:border-gray-700 flex items-center justify-center shrink-0">
                    <i class="fa-solid fa-plus text-gray-300 text-xs"></i>
                </div>
            </div>

        </div>
    </div>

    <!-- VIEW 2: CHATBOT -->
    <div id="chat-view" class="hidden w-full max-w-4xl h-[650px] glass-card rounded-3xl flex flex-col overflow-hidden animate-fade-in shadow-2xl">
        
        <!-- Chat Header -->
        <div class="bg-white/50 dark:bg-black/20 p-4 border-b border-gray-200 dark:border-gray-700/30 flex justify-between items-center backdrop-blur-sm">
            <div class="flex items-center gap-4">
                <div class="relative">
                    <div class="w-12 h-12 rounded-full bg-gradient-to-br from-indigo-500 to-purple-600 flex items-center justify-center text-white shadow-lg">
                        <i class="fa-solid fa-robot text-lg"></i>
                    </div>
                    <span class="absolute bottom-0 right-0 w-3.5 h-3.5 bg-green-500 border-2 border-white dark:border-[#1a1c2e] rounded-full"></span>
                </div>
                <div>
                    <h3 class="font-bold text-gray-800 dark:text-gray-100 text-lg">BatGPT</h3>
                    <p class="text-xs text-indigo-500 dark:text-indigo-400 font-medium">Always Online</p>
                </div>
            </div>
            <button onclick="clearChat()" class="text-gray-500 hover:text-red-500 dark:text-gray-400 dark:hover:text-red-400 transition-colors p-2 rounded-lg hover:bg-gray-100 dark:hover:bg-white/5" title="Clear Conversation">
                <i class="fa-regular fa-trash-can"></i>
            </button>
        </div>

        <!-- Messages Area -->
        <div id="chatMessages" class="flex-grow overflow-y-auto p-4 sm:p-6 space-y-6 scroll-smooth bg-gray-50/50 dark:bg-transparent">
            <!-- Intro Message -->
            <div class="flex items-start gap-3 animate-fade-in">
                <div class="w-9 h-9 rounded-full bg-indigo-100 dark:bg-indigo-600/20 flex items-center justify-center text-indigo-600 dark:text-indigo-400 text-sm shrink-0 border border-indigo-200 dark:border-indigo-500/20">
                    <i class="fa-solid fa-robot"></i>
                </div>
                <div class="chat-bubble-bot p-4 text-sm max-w-[85%] leading-relaxed">
                    <p>Hello! I am BatGPT. Ready to assist with your mission. ðŸ¦‡</p>
                </div>
            </div>
        </div>

        <!-- Chat Input -->
        <div class="p-4 bg-white/50 dark:bg-black/20 border-t border-gray-200 dark:border-gray-700/30 backdrop-blur-sm">
            <form id="chatForm" class="relative flex items-center gap-2">
                <input type="text" id="chatInput" 
                    class="adaptive-input w-full rounded-full py-4 pl-6 pr-14 text-sm font-medium focus:outline-none shadow-sm"
                    placeholder="Ask me anything..." autocomplete="off">
                
                <button type="submit" id="sendBtn" class="absolute right-2 p-2.5 bg-indigo-600 hover:bg-indigo-500 text-white rounded-full transition-all shadow-md disabled:opacity-50 disabled:cursor-not-allowed transform hover:scale-105 active:scale-95">
                    <i class="fa-solid fa-paper-plane text-sm"></i>
                </button>
            </form>
        </div>
    </div>

    <script>
        // --- THEME LOGIC ---
        const themeToggle = document.getElementById('themeToggle');
        const html = document.documentElement;

        // Check Local Storage or System Preference
        if (localStorage.getItem('theme') === 'light') {
            html.classList.remove('dark');
        }

        themeToggle.addEventListener('click', () => {
            html.classList.toggle('dark');
            if (html.classList.contains('dark')) {
                localStorage.setItem('theme', 'dark');
            } else {
                localStorage.setItem('theme', 'light');
            }
        });

        // --- TAB LOGIC ---
        function switchTab(tab) {
            const imageView = document.getElementById('image-view');
            const chatView = document.getElementById('chat-view');
            const tabImage = document.getElementById('tab-image');
            const tabChat = document.getElementById('tab-chat');

            if (tab === 'image') {
                imageView.classList.remove('hidden');
                chatView.classList.add('hidden');
                tabImage.classList.add('active');
                tabChat.classList.remove('active');
            } else {
                imageView.classList.add('hidden');
                chatView.classList.remove('hidden');
                tabImage.classList.remove('active');
                tabChat.classList.add('active');
            }
        }

        // --- SURPRISE ME LOGIC ---
        const creativePrompts = [
            "A cyberpunk street food vendor in Tokyo, neon rain, highly detailed",
            "A cute astronaut cat floating in a galaxy made of candy, 3d render",
            "Portrait of a warrior princess with golden armor, intricate design, cinematic lighting",
            "A cozy cabin in the snowy mountains at sunset, warm light from windows, photorealistic",
            "Steampunk time machine clockwork mechanism, brass and gears, macro shot",
            "A futuristic formula 1 car racing on a mars colony track, motion blur"
        ];

        function surpriseMe() {
            const random = creativePrompts[Math.floor(Math.random() * creativePrompts.length)];
            document.getElementById('promptInput').value = random;
        }

        // --- IMAGE GENERATOR ---
        const generatorForm = document.getElementById('generatorForm');
        const promptInput = document.getElementById('promptInput');
        const styleSelect = document.getElementById('styleSelect');
        const aspectRatio = document.getElementById('aspectRatio');
        const generateBtn = document.getElementById('generateBtn');
        const resultImage = document.getElementById('resultImage');
        const galleryStrip = document.getElementById('galleryStrip');
        const fileInput = document.getElementById('fileInput');
        const fileLabel = document.getElementById('fileLabel');
        const uploadPreview = document.getElementById('uploadPreview');

        // State classes
        const loadingState = document.getElementById('loadingState');
        const placeholderState = document.getElementById('placeholderState');
        const actionOverlay = document.getElementById('actionOverlay');
        const statusBadge = document.getElementById('statusBadge');
        const btnText = document.getElementById('btnText');

        // File Input Preview
        fileInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                fileLabel.textContent = file.name.substring(0, 10) + "...";
                const reader = new FileReader();
                reader.onload = (e) => {
                    uploadPreview.style.backgroundImage = `url(${e.target.result})`;
                    uploadPreview.classList.remove('hidden');
                };
                reader.readAsDataURL(file);
            }
        });

        function addToGallery(url) {
            const img = document.createElement('img');
            img.src = url;
            img.className = "h-16 w-16 rounded-lg object-cover cursor-pointer border-2 border-transparent hover:border-indigo-500 transition-all shrink-0 animate-fade-in";
            img.onclick = () => {
                resultImage.src = url;
            };
            galleryStrip.insertBefore(img, galleryStrip.children[1]); // Insert after label
        }

        generatorForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const rawPrompt = promptInput.value.trim();
            const style = styleSelect.value;
            const ratio = aspectRatio.value;
            const file = fileInput.files[0];

            if (!rawPrompt) return;
            const finalPrompt = style ? `${rawPrompt}, ${style}` : rawPrompt;

            // UI Loading
            generateBtn.disabled = true;
            generateBtn.classList.add('opacity-75', 'cursor-not-allowed');
            btnText.innerHTML = '<i class="fa-solid fa-circle-notch fa-spin"></i> Generating...';
            placeholderState.classList.add('hidden');
            resultImage.classList.add('hidden');
            actionOverlay.classList.add('hidden');
            loadingState.classList.remove('hidden');
            statusBadge.classList.remove('hidden');

            try {
                const baseUrl = "https://famofc.site/api/generate.php";
                let response;

                if (file) {
                    const formData = new FormData();
                    formData.append('prompt', finalPrompt);
                    formData.append('aspectRatio', ratio);
                    formData.append('image', file);
                    response = await fetch(baseUrl, { method: 'POST', body: formData });
                } else {
                    response = await fetch(`${baseUrl}?prompt=${encodeURIComponent(finalPrompt)}&aspectRatio=${ratio}`);
                }
                
                const data = await response.json();
                if (data.success && data.images?.length > 0) {
                    const imgUrl = data.images[0].image_url;
                    
                    // Preload image
                    const tempImg = new Image();
                    tempImg.onload = () => {
                        resultImage.src = imgUrl;
                        resultImage.classList.remove('hidden');
                        actionOverlay.classList.remove('hidden');
                        addToGallery(imgUrl);
                        
                        // Reset Loading UI
                        loadingState.classList.add('hidden');
                        statusBadge.classList.add('hidden');
                        generateBtn.disabled = false;
                        generateBtn.classList.remove('opacity-75', 'cursor-not-allowed');
                        btnText.textContent = 'Generate Masterpiece';
                    }
                    tempImg.src = imgUrl;
                } else {
                    throw new Error("Generation failed");
                }
            } catch (err) {
                console.error(err);
                document.getElementById('errorMessage').classList.remove('hidden');
                document.getElementById('errorText').textContent = "Server busy or offline. Please try again.";
                loadingState.classList.add('hidden');
                statusBadge.classList.add('hidden');
                generateBtn.disabled = false;
                generateBtn.classList.remove('opacity-75', 'cursor-not-allowed');
                btnText.textContent = 'Generate Masterpiece';
            }
        });

        // Download Logic
        document.getElementById('downloadBtn').addEventListener('click', async function() {
            const url = resultImage.src;
            const btn = this;
            const originalHtml = btn.innerHTML;
            btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i>';
            
            try {
                const response = await fetch(url, { mode: 'cors' });
                if (!response.ok) throw new Error("Network");
                const blob = await response.blob();
                const blobUrl = window.URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = blobUrl;
                link.download = `fam-ofc-art-${Date.now()}.png`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            } catch (e) {
                window.open(url, '_blank');
            } finally {
                btn.innerHTML = originalHtml;
            }
        });

        function openFull() {
            window.open(resultImage.src, '_blank');
        }

        // --- CHATBOT ---
        const chatMessages = document.getElementById('chatMessages');
        const chatInput = document.getElementById('chatInput');
        const chatForm = document.getElementById('chatForm');

        chatForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const txt = chatInput.value.trim();
            if(!txt) return;

            addMessage('user', txt);
            chatInput.value = '';
            const loadingId = addLoading();

            try {
                const res = await fetch(`https://batgpt.vercel.app/api/gpt?message=${encodeURIComponent(txt)}`);
                let reply = "";
                const type = res.headers.get("content-type");
                if (type && type.includes("json")) {
                    const d = await res.json();
                    reply = d.content || d.reply || d.text || JSON.stringify(d);
                } else {
                    reply = await res.text();
                }
                removeMsg(loadingId);
                addMessage('bot', reply);
            } catch (e) {
                removeMsg(loadingId);
                addMessage('bot', "Connection error. Please try again.");
            }
        });

        function addMessage(sender, text) {
            const div = document.createElement('div');
            div.className = `flex items-start gap-3 animate-fade-in ${sender === 'user' ? 'flex-row-reverse' : ''}`;
            
            const avatar = sender === 'user' 
                ? `<div class="w-9 h-9 rounded-full bg-gradient-to-br from-indigo-500 to-purple-600 flex items-center justify-center text-white shrink-0 shadow-md"><i class="fa-solid fa-user text-xs"></i></div>`
                : `<div class="w-9 h-9 rounded-full bg-indigo-100 dark:bg-indigo-600/20 flex items-center justify-center text-indigo-600 dark:text-indigo-400 text-sm shrink-0 border border-indigo-200 dark:border-indigo-500/20"><i class="fa-solid fa-robot"></i></div>`;

            const bubbleClass = sender === 'user' ? 'chat-bubble-user' : 'chat-bubble-bot';
            
            // Add Copy Button for Bot
            const copyBtn = sender === 'bot' ? 
                `<button onclick="copyText(this)" class="absolute -bottom-5 right-2 text-xs text-gray-400 hover:text-indigo-500 flex items-center gap-1 opacity-0 group-hover:opacity-100 transition-opacity"><i class="fa-regular fa-copy"></i> Copy</button>` : '';

            div.innerHTML = `
                ${avatar}
                <div class="relative group max-w-[85%]">
                    <div class="${bubbleClass} p-3.5 text-sm leading-relaxed shadow-sm">
                        ${text.replace(/\n/g, '<br>')}
                    </div>
                    ${copyBtn}
                </div>
            `;
            chatMessages.appendChild(div);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        function addLoading() {
            const id = 'l-' + Date.now();
            const div = document.createElement('div');
            div.id = id;
            div.className = "flex items-start gap-3";
            div.innerHTML = `
                <div class="w-9 h-9 rounded-full bg-indigo-100 dark:bg-indigo-600/20 flex items-center justify-center text-indigo-600 dark:text-indigo-400 text-sm shrink-0 border border-indigo-200 dark:border-indigo-500/20"><i class="fa-solid fa-robot"></i></div>
                <div class="chat-bubble-bot p-4 flex gap-1 items-center h-10 bg-white dark:bg-white/5 border border-gray-200 dark:border-white/10 rounded-r-2xl rounded-bl-2xl">
                    <div class="w-1.5 h-1.5 bg-gray-400 rounded-full typing-dot"></div>
                    <div class="w-1.5 h-1.5 bg-gray-400 rounded-full typing-dot"></div>
                    <div class="w-1.5 h-1.5 bg-gray-400 rounded-full typing-dot"></div>
                </div>
            `;
            chatMessages.appendChild(div);
            chatMessages.scrollTop = chatMessages.scrollHeight;
            return id;
        }

        function removeMsg(id) { document.getElementById(id)?.remove(); }
        function clearChat() { chatMessages.innerHTML = ''; }
        
        function copyText(btn) {
            const text = btn.previousElementSibling.innerText;
            navigator.clipboard.writeText(text);
            const original = btn.innerHTML;
            btn.innerHTML = '<i class="fa-solid fa-check"></i> Copied';
            setTimeout(() => btn.innerHTML = original, 2000);
        }
    </script>
</body>
</html>


